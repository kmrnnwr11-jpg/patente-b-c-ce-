# .cursorrules - App Patente B 2025

## üéØ PROGETTO

App web (PWA) per preparazione esame Patente B italiana.

**Target**: Candidati patente che vogliono quiz, teoria, spiegazioni AI e supporto multilingua.

---

## üõ†Ô∏è STACK TECNOLOGICO

### Core
- **Framework**: React 18+ con Vite
- **Linguaggio**: TypeScript (strict mode)
- **Styling**: Tailwind CSS 3+ (solo classi core utility)
- **UI Components**: shadcn/ui + Lucide React icons
- **State**: Zustand per stato globale
- **Routing**: React Router v6

### Backend & APIs
- **Database**: Firebase Firestore
- **Auth**: Firebase Authentication
- **Storage**: Firebase Storage (immagini quiz)
- **AI Spiegazioni**: Claude API (Anthropic) - claude-sonnet-4-5-20250929
- **Text-to-Speech**: ElevenLabs API (eleven_multilingual_v2)
- **Pagamenti**: Stripe (future implementation)

### Build & Deploy
- **Build**: Vite
- **Hosting**: Vercel/Netlify
- **PWA**: Workbox per service worker

---

## üìê ARCHITETTURA & CONVENZIONI

### Struttura File
```
src/
‚îú‚îÄ‚îÄ components/          # Componenti UI organizzati per feature
‚îÇ   ‚îú‚îÄ‚îÄ landing/        # Landing page
‚îÇ   ‚îú‚îÄ‚îÄ auth/           # Autenticazione
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/      # Dashboard utente
‚îÇ   ‚îú‚îÄ‚îÄ quiz/           # Sistema quiz
‚îÇ   ‚îú‚îÄ‚îÄ study/          # Modalit√† studio
‚îÇ   ‚îú‚îÄ‚îÄ theory/         # Sezione teoria
‚îÇ   ‚îú‚îÄ‚îÄ ai/             # Features AI
‚îÇ   ‚îú‚îÄ‚îÄ stats/          # Statistiche
‚îÇ   ‚îú‚îÄ‚îÄ payment/        # Monetizzazione
‚îÇ   ‚îú‚îÄ‚îÄ layout/         # Layout components (Navbar, Footer)
‚îÇ   ‚îî‚îÄ‚îÄ ui/             # Componenti riutilizzabili (shadcn)
‚îú‚îÄ‚îÄ lib/                # Utilities e configurazioni
‚îú‚îÄ‚îÄ hooks/              # Custom React hooks
‚îú‚îÄ‚îÄ store/              # Zustand stores
‚îú‚îÄ‚îÄ types/              # TypeScript types e interfaces
‚îú‚îÄ‚îÄ styles/             # CSS globale e temi
‚îú‚îÄ‚îÄ pages/              # Route pages
‚îî‚îÄ‚îÄ data/               # Dati statici (quiz.json, teoria)
```

### Naming Conventions
- **Componenti**: PascalCase (`QuizCard.tsx`)
- **File utility**: camelCase (`formatTime.ts`)
- **Costanti**: UPPER_SNAKE_CASE (`MAX_ERRORS`)
- **Hooks**: usePrefisso (`useQuizTimer.ts`)
- **Types**: PascalCase (`QuizQuestion`, `UserProfile`)
- **Event handlers**: handlePrefisso (`handleSubmit`, `handleClick`)

### Component Pattern
```typescript
// Preferire functional components con TypeScript
import { FC } from 'react';

interface QuizCardProps {
  question: string;
  imageUrl?: string;
  onAnswer: (answer: boolean) => void;
}

export const QuizCard: FC<QuizCardProps> = ({ question, imageUrl, onAnswer }) => {
  return (
    <div className="glass-card p-6">
      {/* Component content */}
    </div>
  );
};
```

### Import Order
```typescript
// 1. React & external libraries
import { FC, useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';

// 2. Internal components
import { Button } from '@/components/ui/Button';
import { QuizCard } from '@/components/quiz/QuizCard';

// 3. Hooks & stores
import { useStore } from '@/store/useStore';
import { useQuizTimer } from '@/hooks/useQuizTimer';

// 4. Utils & types
import { formatTime } from '@/lib/utils';
import { QuizQuestion } from '@/types';

// 5. Constants & config
import { EXAM_CONFIG } from '@/lib/constants';
```

---

## üé® DESIGN SYSTEM

### Glassmorphism Style
```css
/* Pattern principale per card/container */
.glass-card {
  backdrop-filter: blur(12px) saturate(180%);
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 1.5rem; /* 24px */
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

/* Dark mode */
.dark .glass-card {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Varianti */
.glass-card-strong {
  backdrop-filter: blur(16px) saturate(200%);
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.glass-button {
  backdrop-filter: blur(8px);
  background: rgba(59, 130, 246, 0.9);
  border: 1px solid rgba(147, 197, 253, 0.3);
  transition: all 0.2s ease;
}

.glass-button:hover {
  background: rgba(59, 130, 246, 1);
  transform: translateY(-2px) scale(1.02);
}
```

### Color Palette (Blu Istituzionale)
```typescript
// Definito in tailwind.config.js
colors: {
  primary: {
    50: '#eff6ff',
    100: '#dbeafe',
    200: '#bfdbfe',
    300: '#93c5fd',
    400: '#60a5fa',
    500: '#3b82f6',  // Blu principale ‚≠ê
    600: '#2563eb',
    700: '#1d4ed8',
    800: '#1e40af',
    900: '#1e3a8a',
  },
  success: '#10b981',
  error: '#ef4444',
  warning: '#f59e0b',
}
```

### Typography
```typescript
// Font stack: Inter per leggibilit√†
fontFamily: {
  sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
}

// Sizes
text-sm   // 14px - UI secondario
text-base // 16px - Default
text-lg   // 18px - Domande quiz
text-xl   // 20px - Titoli sezione
text-2xl  // 24px - Titoli pagina
text-5xl  // 48px - Hero title
text-7xl  // 72px - Hero XL

// Weights
font-normal    // 400
font-medium    // 500
font-semibold  // 600
font-bold      // 700
```

### Spacing & Layout
```typescript
// Container max-width
max-w-7xl mx-auto px-4  // Standard container

// Card padding
p-6  // Default card padding (24px)
p-4  // Compact card (16px)

// Spacing between sections
space-y-8   // 32px vertical spacing
space-y-12  // 48px vertical spacing
```

### Icons & Buttons
```typescript
// Usa Lucide React per icone
import { Check, X, Clock, BookOpen, Brain, Trophy } from 'lucide-react';

// Dimensioni icone
size={16}  // Small (UI compact)
size={20}  // Default
size={24}  // Large (buttons, features)
size={28}  // XL (hero icons)

// Dimensioni bottoni
className="h-11 px-6 py-3 rounded-xl"  // Default button
className="h-9 px-4 py-2 rounded-lg"   // Small button
className="h-12 px-8 py-4 rounded-xl"  // Large button
```

### Dark Mode
```typescript
// Usa Tailwind dark: prefix
className="bg-white dark:bg-gray-900"
className="text-gray-900 dark:text-gray-100"
className="border-gray-200 dark:border-gray-700"

// Implementazione toggle
const { theme, toggleTheme } = useStore();

// Persistenza in localStorage
localStorage.setItem('theme', theme);
```

### Responsive Breakpoints
```typescript
// Mobile first approach
sm:   // 640px  - Small tablets
md:   // 768px  - Tablets
lg:   // 1024px - Laptops
xl:   // 1280px - Desktops
2xl:  // 1536px - Large screens

// Example
className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3"
```

---

## üî• FIREBASE SETUP

### Configurazione
```typescript
// lib/firebase.ts
import { initializeApp } from 'firebase/app';
import { getFirestore } from 'firebase/firestore';
import { getAuth } from 'firebase/auth';
import { getStorage } from 'firebase/storage';

const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID
};

export const app = initializeApp(firebaseConfig);
export const db = getFirestore(app);
export const auth = getAuth(app);
export const storage = getStorage(app);
```

### Firestore Schema
```typescript
// users/{userId}
interface User {
  uid: string;
  email: string;
  displayName: string;
  plan: 'free' | 'premium';
  aiExplanationsLeft: number;    // 5 per free, reset giornaliero
  translationsLeft: number;      // 30 per free
  lastQuotaReset: Timestamp;
  streak: number;                // Giorni consecutivi
  createdAt: Timestamp;
  lastActiveAt: Timestamp;
}

// quiz_attempts/{attemptId}
interface QuizAttempt {
  attemptId: string;
  userId: string;
  startedAt: Timestamp;
  completedAt: Timestamp | null;
  questions: QuestionAttempt[];
  score: number;
  errors: number;
  timeElapsed: number; // secondi
  mode: 'exam' | 'practice';
  passed: boolean;
}

// user_progress/{userId}
interface UserProgress {
  userId: string;
  totalAttempts: number;
  passedExams: number;
  weakArguments: string[];       // Top 5 argomenti con pi√π errori
  studyProgress: Record<string, number>; // argomento: percentuale
  bookmarkedQuestions: number[];
  lastStudiedTopics: string[];
}
```

### Firestore Operations
```typescript
// Read
import { doc, getDoc, collection, query, where, getDocs } from 'firebase/firestore';

const userDoc = await getDoc(doc(db, 'users', userId));
const userData = userDoc.data() as User;

// Write
import { setDoc, updateDoc, addDoc } from 'firebase/firestore';

await setDoc(doc(db, 'users', userId), userData);
await updateDoc(doc(db, 'users', userId), { aiExplanationsLeft: 5 });

// Query
const q = query(
  collection(db, 'quiz_attempts'),
  where('userId', '==', userId),
  where('passed', '==', true)
);
const querySnapshot = await getDocs(q);
```

---

## üß† AI INTEGRATION

### Claude API (Spiegazioni)
```typescript
// lib/claude.ts
const CLAUDE_API_KEY = import.meta.env.VITE_CLAUDE_API_KEY;
const CLAUDE_MODEL = 'claude-sonnet-4-5-20250929';

export async function getAIExplanation(
  question: string,
  correctAnswer: boolean,
  userAnswer: boolean
): Promise<string> {
  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'x-api-key': CLAUDE_API_KEY,
        'anthropic-version': '2023-06-01',
        'content-type': 'application/json'
      },
      body: JSON.stringify({
        model: CLAUDE_MODEL,
        max_tokens: 300,
        messages: [{
          role: 'user',
          content: `Sei un istruttore di scuola guida esperto. Spiega in italiano semplice (max 2-3 frasi) perch√© la risposta corretta a questa domanda √® ${correctAnswer ? 'VERO' : 'FALSO'}:

"${question}"

L'utente ha risposto: ${userAnswer ? 'VERO' : 'FALSO'}
${userAnswer === correctAnswer 
  ? 'Corretto! Spiega brevemente perch√© questa √® la risposta giusta.' 
  : 'Sbagliato. Spiega l\'errore e la regola corretta del codice della strada.'
}`
        }]
      })
    });

    if (!response.ok) {
      throw new Error(`Claude API error: ${response.status}`);
    }

    const data = await response.json();
    return data.content[0].text;
  } catch (error) {
    console.error('Claude API error:', error);
    throw new Error('Spiegazione non disponibile al momento');
  }
}
```

### AI Quota Management
```typescript
// lib/quota.ts
import { doc, getDoc, updateDoc, Timestamp } from 'firebase/firestore';

export async function checkAIQuota(userId: string): Promise<{
  hasQuota: boolean;
  remaining: number;
}> {
  const userDoc = await getDoc(doc(db, 'users', userId));
  const user = userDoc.data() as User;
  
  // Premium = unlimited
  if (user.plan === 'premium') {
    return { hasQuota: true, remaining: 999 };
  }
  
  // Check if need reset (new day)
  const now = new Date();
  const lastReset = user.lastQuotaReset?.toDate();
  const isNewDay = !lastReset || 
    now.toDateString() !== lastReset.toDateString();
  
  if (isNewDay) {
    // Reset quota
    await updateDoc(doc(db, 'users', userId), {
      aiExplanationsLeft: 5,
      lastQuotaReset: Timestamp.now()
    });
    return { hasQuota: true, remaining: 5 };
  }
  
  // Return current quota
  return {
    hasQuota: user.aiExplanationsLeft > 0,
    remaining: user.aiExplanationsLeft
  };
}

export async function decrementAIQuota(userId: string): Promise<void> {
  const userDoc = await getDoc(doc(db, 'users', userId));
  const user = userDoc.data() as User;
  
  if (user.plan === 'premium') return; // No decrement for premium
  
  await updateDoc(doc(db, 'users', userId), {
    aiExplanationsLeft: Math.max(0, user.aiExplanationsLeft - 1)
  });
}
```

### AI Explanation Cache
```typescript
// Risparmia API calls cachando spiegazioni in Firestore
// ai_explanations_cache/{questionId}
interface AIExplanationCache {
  questionId: number;
  explanation: string;
  cachedAt: Timestamp;
  usageCount: number;
}

export async function getCachedExplanation(
  questionId: number
): Promise<string | null> {
  try {
    const cacheDoc = await getDoc(
      doc(db, 'ai_explanations_cache', questionId.toString())
    );
    
    if (cacheDoc.exists()) {
      const cache = cacheDoc.data() as AIExplanationCache;
      
      // Incrementa usage count
      await updateDoc(cacheDoc.ref, {
        usageCount: cache.usageCount + 1,
        lastUsedAt: Timestamp.now()
      });
      
      return cache.explanation;
    }
    
    return null;
  } catch (error) {
    console.error('Cache read error:', error);
    return null;
  }
}

export async function cacheExplanation(
  questionId: number,
  explanation: string
): Promise<void> {
  await setDoc(doc(db, 'ai_explanations_cache', questionId.toString()), {
    questionId,
    explanation,
    cachedAt: Timestamp.now(),
    usageCount: 1
  });
}
```

### ElevenLabs API (Text-to-Speech)
```typescript
// lib/elevenlabs.ts
const ELEVENLABS_API_KEY = import.meta.env.VITE_ELEVENLABS_API_KEY;
const VOICE_IDS = {
  it: 'YOUR_ITALIAN_VOICE_ID',
  en: 'YOUR_ENGLISH_VOICE_ID',
  // ... altri
};

export async function generateAudio(
  text: string,
  language: 'it' | 'en' | 'es' | 'fr' | 'de' = 'it'
): Promise<Blob> {
  try {
    const voiceId = VOICE_IDS[language];
    const response = await fetch(
      `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`,
      {
        method: 'POST',
        headers: {
          'xi-api-key': ELEVENLABS_API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          text,
          model_id: 'eleven_multilingual_v2',
          voice_settings: {
            stability: 0.5,
            similarity_boost: 0.75,
            style: 0.5,
            use_speaker_boost: true
          }
        })
      }
    );

    if (!response.ok) {
      throw new Error(`ElevenLabs API error: ${response.status}`);
    }

    return await response.blob();
  } catch (error) {
    console.error('ElevenLabs API error:', error);
    throw new Error('Audio non disponibile');
  }
}

// Cache audio in Firebase Storage
export async function getCachedAudio(
  questionId: number,
  language: string
): Promise<string | null> {
  try {
    const audioRef = ref(storage, `audio/${language}/${questionId}.mp3`);
    return await getDownloadURL(audioRef);
  } catch {
    return null;
  }
}

export async function saveAudioToStorage(
  questionId: number,
  language: string,
  audioBlob: Blob
): Promise<string> {
  const audioRef = ref(storage, `audio/${language}/${questionId}.mp3`);
  await uploadBytes(audioRef, audioBlob);
  return await getDownloadURL(audioRef);
}
```

---

## üìù QUIZ LOGIC

### Domande Dataset
```typescript
// Usa dataset: Ed0ardo/QuizPatenteB (7139 domande)
// Oppure crea src/data/questions.json

interface QuizQuestion {
  id: number;
  domanda: string;
  risposta: boolean; // true = VERO, false = FALSO
  immagine?: string; // URL o path
  argomento: string; // 1 dei 25 argomenti ministeriali
}

// Carica domande
import questionsData from '@/data/questions.json';

export const questions: QuizQuestion[] = questionsData;
```

### Quiz Generator
```typescript
// lib/quizGenerator.ts
import { shuffleArray } from '@/lib/utils';
import { EXAM_CONFIG } from '@/lib/constants';

// Genera quiz esame (30 domande random)
export function generateExamQuiz(questions: QuizQuestion[]): QuizQuestion[] {
  const shuffled = shuffleArray(questions);
  return shuffled.slice(0, EXAM_CONFIG.TOTAL_QUESTIONS);
}

// Genera quiz per argomento
export function generateTopicQuiz(
  questions: QuizQuestion[],
  argomento: string,
  count: number = 10
): QuizQuestion[] {
  const filtered = questions.filter(q => q.argomento === argomento);
  const shuffled = shuffleArray(filtered);
  return shuffled.slice(0, Math.min(count, filtered.length));
}

// Genera quiz sui punti deboli
export function generateWeakTopicsQuiz(
  questions: QuizQuestion[],
  weakTopics: string[],
  count: number = 20
): QuizQuestion[] {
  const filtered = questions.filter(q => weakTopics.includes(q.argomento));
  const shuffled = shuffleArray(filtered);
  return shuffled.slice(0, count);
}
```

### Timer Hook
```typescript
// hooks/useQuizTimer.ts
import { useState, useEffect, useCallback } from 'react';

export function useQuizTimer(durationSeconds: number = 1200) {
  const [timeLeft, setTimeLeft] = useState(durationSeconds);
  const [isRunning, setIsRunning] = useState(false);
  const [hasExpired, setHasExpired] = useState(false);

  useEffect(() => {
    if (!isRunning || timeLeft <= 0) {
      if (timeLeft <= 0 && !hasExpired) {
        setHasExpired(true);
      }
      return;
    }

    const interval = setInterval(() => {
      setTimeLeft(prev => {
        if (prev <= 1) {
          setIsRunning(false);
          setHasExpired(true);
          return 0;
        }
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(interval);
  }, [isRunning, timeLeft, hasExpired]);

  const start = useCallback(() => setIsRunning(true), []);
  const pause = useCallback(() => setIsRunning(false), []);
  const reset = useCallback(() => {
    setTimeLeft(durationSeconds);
    setIsRunning(false);
    setHasExpired(false);
  }, [durationSeconds]);

  return {
    timeLeft,
    isRunning,
    hasExpired,
    start,
    pause,
    reset,
    formatted: formatTime(timeLeft)
  };
}

// Format MM:SS
function formatTime(seconds: number): string {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}
```

### Quiz Validation
```typescript
// lib/quizValidation.ts
import { EXAM_CONFIG } from '@/lib/constants';

export interface QuizResult {
  passed: boolean;
  score: number;
  errors: number;
  correctAnswers: number;
  percentage: number;
}

export function validateExam(
  userAnswers: (boolean | null)[],
  questions: QuizQuestion[]
): QuizResult {
  let errors = 0;
  let correctAnswers = 0;

  userAnswers.forEach((answer, index) => {
    if (answer === null) {
      errors++; // Non risposto = errore
    } else if (answer !== questions[index].risposta) {
      errors++;
    } else {
      correctAnswers++;
    }
  });

  const score = EXAM_CONFIG.TOTAL_QUESTIONS - errors;
  const passed = errors <= EXAM_CONFIG.MAX_ERRORS_TO_PASS;
  const percentage = Math.round((correctAnswers / EXAM_CONFIG.TOTAL_QUESTIONS) * 100);

  return {
    passed,
    score,
    errors,
    correctAnswers,
    percentage
  };
}

export function isQuizComplete(answers: (boolean | null)[]): boolean {
  return answers.every(a => a !== null);
}

export function getAnsweredCount(answers: (boolean | null)[]): number {
  return answers.filter(a => a !== null).length;
}
```

### Auto-Save Hook
```typescript
// hooks/useAutoSave.ts
import { useEffect, useRef } from 'react';
import { debounce } from '@/lib/utils';

export function useAutoSave<T>(
  data: T,
  onSave: (data: T) => Promise<void>,
  interval: number = 30000 // 30 secondi
) {
  const dataRef = useRef(data);
  const lastSavedRef = useRef<string>(JSON.stringify(data));

  useEffect(() => {
    dataRef.current = data;
  }, [data]);

  useEffect(() => {
    const debouncedSave = debounce(async () => {
      const currentData = JSON.stringify(dataRef.current);
      if (currentData !== lastSavedRef.current) {
        try {
          await onSave(dataRef.current);
          lastSavedRef.current = currentData;
          console.log('Auto-saved at', new Date().toLocaleTimeString());
        } catch (error) {
          console.error('Auto-save failed:', error);
        }
      }
    }, 1000);

    const intervalId = setInterval(debouncedSave, interval);

    return () => {
      clearInterval(intervalId);
      debouncedSave.cancel?.();
    };
  }, [onSave, interval]);
}
```

---

## üåç MULTILINGUA & TRADUZIONE

### Lingue Supportate
```typescript
// lib/constants.ts
export const LANGUAGES = [
  { code: 'it', name: 'Italiano', flag: 'üáÆüáπ' },
  { code: 'en', name: 'English', flag: 'üá¨üáß' },
  { code: 'fr', name: 'Fran√ßais', flag: 'üá´üá∑' },
  { code: 'de', name: 'Deutsch', flag: 'üá©üá™' },
  { code: 'es', name: 'Espa√±ol', flag: 'üá™üá∏' },
  { code: 'ar', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', flag: 'üá∏üá¶' },
  { code: 'zh', name: '‰∏≠Êñá', flag: 'üá®üá≥' },
  { code: 'ro', name: 'Rom√¢nƒÉ', flag: 'üá∑üá¥' },
] as const;
```

### Translation Service
```typescript
// lib/translation.ts
// Usa Google Cloud Translation API o LibreTranslate (self-hosted)

interface TranslationCache {
  questionId: number;
  language: string;
  translated: string;
  cachedAt: Timestamp;
}

export async function translateQuestion(
  questionId: number,
  text: string,
  targetLang: string
): Promise<string> {
  // 1. Check cache first
  const cached = await getCachedTranslation(questionId, targetLang);
  if (cached) return cached;

  // 2. Call translation API
  try {
    const translated = await callTranslationAPI(text, targetLang);
    
    // 3. Cache result
    await cacheTranslation(questionId, targetLang, translated);
    
    return translated;
  } catch (error) {
    console.error('Translation error:', error);
    return text; // Fallback to original
  }
}

async function callTranslationAPI(
  text: string,
  targetLang: string
): Promise<string> {
  // Implementa con Google Translate o LibreTranslate
  // Nota: preferire LibreTranslate per privacy e costi
  const response = await fetch('https://libretranslate.com/translate', {
    method: 'POST',
    body: JSON.stringify({
      q: text,
      source: 'it',
      target: targetLang,
      format: 'text'
    }),
    headers: { 'Content-Type': 'application/json' }
  });

  const data = await response.json();
  return data.translatedText;
}
```

---

## üí∞ MONETIZZAZIONE

### Quota System
```typescript
// lib/constants.ts
export const QUOTA_CONFIG = {
  FREE_AI_EXPLANATIONS_DAILY: 5,
  FREE_TRANSLATIONS_DAILY: 30,
  PREMIUM_UNLIMITED: 999999,
} as const;

export const PREMIUM_CONFIG = {
  PRICE_EUR: 4.99,
  CURRENCY: 'EUR',
  BILLING_INTERVAL: 'month',
  FEATURES: [
    'Spiegazioni AI illimitate',
    'Traduzioni illimitate',
    'Audio multilingua',
    'Statistiche avanzate',
    'Nessuna pubblicit√†',
    'Supporto prioritario'
  ]
} as const;
```

### Paywall Component
```typescript
// components/payment/PaywallModal.tsx
import { FC } from 'react';
import { Dialog, DialogContent } from '@/components/ui/Dialog';
import { Button } from '@/components/ui/Button';
import { Sparkles } from 'lucide-react';

interface PaywallModalProps {
  open: boolean;
  onClose: () => void;
  feature: string;
  quotaRemaining: number;
}

export const PaywallModal: FC<PaywallModalProps> = ({
  open,
  onClose,
  feature,
  quotaRemaining
}) => {
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="glass-card max-w-md">
        <div className="text-center">
          <Sparkles size={48} className="mx-auto mb-4 text-primary-500" />
          <h2 className="text-2xl font-bold mb-2">
            Quota Esaurita per Oggi
          </h2>
          <p className="text-muted-foreground mb-6">
            Hai usato tutte le {feature} gratuite di oggi ({quotaRemaining}/giorno).
            Passa a Premium per accesso illimitato!
          </p>

          <div className="glass-card-strong p-6 mb-6 text-left">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-xl font-bold">Premium</h3>
              <div className="text-right">
                <div className="text-3xl font-bold text-primary-500">
                  ‚Ç¨4.99
                </div>
                <div className="text-sm text-muted-foreground">/mese</div>
              </div>
            </div>

            <ul className="space-y-2 text-sm">
              {PREMIUM_CONFIG.FEATURES.map((feature, i) => (
                <li key={i} className="flex items-center gap-2">
                  <Check size={16} className="text-success" />
                  <span>{feature}</span>
                </li>
              ))}
            </ul>
          </div>

          <div className="flex gap-3">
            <Button variant="outline" onClick={onClose} className="flex-1">
              Forse Dopo
            </Button>
            <Button className="flex-1" onClick={() => {/* Navigate to checkout */}}>
              Passa a Premium
            </Button>
          </div>

          <p className="text-xs text-muted-foreground mt-4">
            Quota si rinnova domani alle 00:00
          </p>
        </div>
      </DialogContent>
    </Dialog>
  );
};
```

### Stripe Integration (FASE 9)
```typescript
// lib/stripe.ts
import { loadStripe } from '@stripe/stripe-js';

const stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLIC_KEY);

export async function createCheckoutSession(
  userId: string,
  priceId: string
): Promise<void> {
  const stripe = await stripePromise;
  
  // Call your backend to create checkout session
  const response = await fetch('/api/create-checkout-session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, priceId })
  });

  const { sessionId } = await response.json();
  
  // Redirect to Stripe Checkout
  const result = await stripe?.redirectToCheckout({ sessionId });
  
  if (result?.error) {
    console.error(result.error.message);
  }
}
```

---

## ‚ö° PERFORMANCE & PWA

### Service Worker Strategy
```javascript
// public/sw.js (generated by Workbox)
// vite-plugin-pwa handles this automatically

// Cache strategies:
// - Questions JSON: Cache First (immutabili)
// - Images: Cache First con expiration
// - API calls: Network First con cache fallback
// - Static assets: Cache First

// Esempio custom caching in vite.config.ts:
workbox: {
  globPatterns: ['**/*.{js,css,html,ico,png,svg,json,woff2}'],
  runtimeCaching: [
    {
      urlPattern: /^https:\/\/firebasestorage\.googleapis\.com\/.*/i,
      handler: 'CacheFirst',
      options: {
        cacheName: 'firebase-images',
        expiration: {
          maxEntries: 100,
          maxAgeSeconds: 60 * 60 * 24 * 30 // 30 giorni
        }
      }
    },
    {
      urlPattern: /^https:\/\/api\.anthropic\.com\/.*/i,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'ai-responses',
        networkTimeoutSeconds: 10
      }
    }
  ]
}
```

### Code Splitting
```typescript
// App.tsx - Lazy load routes
import { lazy, Suspense } from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';

const LandingPage = lazy(() => import('@/pages/LandingPage'));
const Dashboard = lazy(() => import('@/pages/DashboardPage'));
const ExamPage = lazy(() => import('@/pages/ExamPage'));
const StudyPage = lazy(() => import('@/pages/StudyPage'));

function App() {
  return (
    <BrowserRouter>
      <Suspense fallback={<LoadingSpinner />}>
        <Routes>
          <Route path="/" element={<LandingPage />} />
          <Route path="/dashboard" element={<Dashboard />} />
          <Route path="/exam" element={<ExamPage />} />
          <Route path="/study" element={<StudyPage />} />
        </Routes>
      </Suspense>
    </BrowserRouter>
  );
}
```

### Image Optimization
```typescript
// Lazy load images in QuestionCard
import { useState, useEffect } from 'react';

function LazyImage({ src, alt }: { src: string; alt: string }) {
  const [loaded, setLoaded] = useState(false);

  return (
    <div className="relative aspect-video bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden">
      {!loaded && (
        <div className="absolute inset-0 flex items-center justify-center">
          <LoadingSpinner />
        </div>
      )}
      <img
        src={src}
        alt={alt}
        loading="lazy"
        onLoad={() => setLoaded(true)}
        className={`w-full h-full object-contain transition-opacity ${
          loaded ? 'opacity-100' : 'opacity-0'
        }`}
      />
    </div>
  );
}
```

---

## üîí SECURITY & BEST PRACTICES

### Firestore Security Rules
```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users can only read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Quiz attempts
    match /quiz_attempts/{attemptId} {
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // User progress
    match /user_progress/{userId} {
      allow read, write: if request.auth != null && 
                            request.auth.uid == userId;
    }
    
    // Theory chapters (public read)
    match /teoria/{topicId} {
      allow read: if true;
      allow write: if false; // Admin only via Cloud Functions
    }
    
    // AI cache (read for all authenticated, write via Cloud Function)
    match /ai_explanations_cache/{questionId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}
```

### Input Validation
```typescript
// Sempre valida input utente
export function validateEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

export function sanitizeInput(input: string): string {
  return input
    .trim()
    .replace(/<script[^>]*>.*?<\/script>/gi, '')
    .replace(/<[^>]+>/g, '');
}
```

### Rate Limiting
```typescript
// Implementa rate limiting per API calls
const rateLimiter = new Map<string, number>();

export function checkRateLimit(userId: string, maxPerMinute: number = 10): boolean {
  const now = Date.now();
  const userRequests = rateLimiter.get(userId) || 0;
  
  if (userRequests >= maxPerMinute) {
    return false; // Rate limit exceeded
  }
  
  rateLimiter.set(userId, userRequests + 1);
  
  // Reset after 1 minute
  setTimeout(() => {
    rateLimiter.delete(userId);
  }, 60000);
  
  return true;
}
```

### Error Handling
```typescript
// Usa try-catch e error boundaries
export async function safeAsyncOperation<T>(
  operation: () => Promise<T>,
  fallback: T
): Promise<T> {
  try {
    return await operation();
  } catch (error) {
    console.error('Operation failed:', error);
    return fallback;
  }
}

// React Error Boundary
class ErrorBoundary extends React.Component<{children: ReactNode}> {
  state = { hasError: false };

  static getDerivedStateFromError() {
    return { hasError: true };
  }

  render() {
    if (this.state.hasError) {
      return <ErrorFallback />;
    }
    return this.props.children;
  }
}
```

---

## üß™ TESTING (FASE 11 - Post-Launch)

### Unit Tests (Jest + React Testing Library)
```typescript
// __tests__/utils/formatTime.test.ts
import { formatTime } from '@/lib/utils';

describe('formatTime', () => {
  it('formats seconds correctly', () => {
    expect(formatTime(0)).toBe('00:00');
    expect(formatTime(59)).toBe('00:59');
    expect(formatTime(60)).toBe('01:00');
    expect(formatTime(1200)).toBe('20:00');
  });
});

// __tests__/components/QuizCard.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { QuizCard } from '@/components/quiz/QuizCard';

describe('QuizCard', () => {
  it('renders question correctly', () => {
    render(
      <QuizCard
        question="Test question?"
        onAnswer={jest.fn()}
      />
    );
    
    expect(screen.getByText('Test question?')).toBeInTheDocument();
  });

  it('calls onAnswer when button clicked', () => {
    const mockOnAnswer = jest.fn();
    render(<QuizCard question="Test?" onAnswer={mockOnAnswer} />);
    
    fireEvent.click(screen.getByText('VERO'));
    expect(mockOnAnswer).toHaveBeenCalledWith(true);
  });
});
```

---

## ‚ö†Ô∏è LIMITAZIONI & NOTES

### ‚ùå NON USARE
- **localStorage/sessionStorage** per dati critici ‚Üí Usa Firestore
- **fetch senza error handling** ‚Üí Sempre wrap in try-catch
- **any type in TypeScript** ‚Üí Usa unknown se necessario
- **Inline styles** ‚Üí Usa solo Tailwind classes
- **Custom CSS classes** non compilate ‚Üí Usa solo utility Tailwind
- **Component class-based** ‚Üí Solo functional components

### ‚úÖ DA FARE SEMPRE
- TypeScript strict mode ATTIVO
- Props interface per ogni componente
- Error boundaries per sezioni critiche
- Loading states per async operations
- Optimistic UI updates dove possibile
- Cache API responses in Firestore
- Lazy load routes e images
- Test su mobile PRIMA di desktop

### üéØ PRIORIT√Ä FEATURES
1. Quiz system funzionante (FASE 4) - **CORE**
2. AI spiegazioni con quota (FASE 6) - **DIFFERENZIATORE**
3. Monetizzazione paywall (FASE 9) - **BUSINESS**
4. Stats e gamification (FASE 8) - **RETENTION**
5. Audio multilingua (FASE 6) - **NICE-TO-HAVE**

---

## üìö RISORSE UTILI

### Documentazione
- React: https://react.dev
- TypeScript: https://www.typescriptlang.org/docs
- Tailwind CSS: https://tailwindcss.com/docs
- Firebase: https://firebase.google.com/docs
- Zustand: https://docs.pmnd.rs/zustand
- shadcn/ui: https://ui.shadcn.com

### Dataset Quiz
- GitHub: Ed0ardo/QuizPatenteB
- Formato: JSON con 7139 domande ministeriali

### APIs
- Claude: https://docs.anthropic.com/claude/reference
- ElevenLabs: https://docs.elevenlabs.io
- Stripe: https://stripe.com/docs/api

---

## üöÄ WORKFLOW SVILUPPO

### Branch Strategy
```bash
main           # Production
‚îî‚îÄ‚îÄ develop    # Development
    ‚îú‚îÄ‚îÄ feature/quiz-system
    ‚îú‚îÄ‚îÄ feature/ai-integration
    ‚îî‚îÄ‚îÄ feature/payment
```

### Commit Convention
```
feat: add quiz timer component
fix: correct answer validation logic
refactor: optimize quiz generator
style: update glassmorphism effects
docs: update README with setup steps
```

### Pre-Commit Checklist
- [ ] `npm run lint` passa
- [ ] TypeScript compila senza errori
- [ ] Componenti testati su mobile
- [ ] Dark mode funzionante
- [ ] No console.log in produzione
- [ ] Import organizzati correttamente

---

**Fine .cursorrules - Segui STRETTAMENTE queste convenzioni!**
